坐牢场

我果然还是不会 D2T2

# T1

如果确定了每条边有无被修改，其概率几何？
$$
\left(\prod p_i\right)^{-k}\left[\frac{x^k}{k!}\right]\prod_{i=1}^n\sum_{j=1}^{\infin}\frac{p_i^{a_i+2j}x^{a_i+2j}}{(a_i+2j)!}
$$
然后就不会优化了。。

如果 $a_i=0$，那么它就是
$$
\sum_{j=1}^{\infin}\frac{p_i^{2j}x^{2j}}{(2j)!}=\frac{e^{p_ix}+e^{-p_ix}}2
$$
否则就是
$$
\sum_{j=1}^{\infin}\frac{p_i^{1+2j}x^{1+2j}}{(1+2j)!}=\frac{e^{p_ix}-e^{-p_ix}}2
$$
然后貌似就能做特殊性质 A 了。

你发现整个东西最终可以整理成 $\left[\frac{x^k}{k!}\right]\sum c_ie^{ix}$ 的形式。

令 $y\gets e^x$，那么只需要计算 $\dfrac{y^{p_i}+y^{-p_i}}2$ 或 $\dfrac{y^{p_i}-y^{-p_i}}2$ 的积就可以了。

可以暴力卷，复杂度不知道为什么是对的。不过可以直接 拉格朗日插值，应该也可以。

连通块大小之积可以转化为每个连通块内恰好选一个的方案数，这样就可以不用把连通块大小记进状态里了。~~貌似是一个相当典的 Trick 啊怎么就我想半天没想到~~。

感觉就一很典的 Chimera 题。

# T2

看错题了原来……

对着错误的题意想了 3h+……

没看到要求 $(i,j)\notin E$……

退役吧

对于 $P=0$ 的情况，容易发现要求每个连通块都是完全图。

答案就是 Bell 数。

且可以证明，一个不为完全图的连通块 $S$ 的三元组数量 $\ge |S|-2$。

然后只用搜出来 $P$ 较小的连通图个数即可。

遵循这样的搜索原则：从最小的点开始 BFS，每次优先搜索编号最小的点。

搜出所有按 BFS 序为 $1,2,\dots$ 的图，计算有多少种重编号的方式。

记 $b_i$ 表示与 $i$ 有连边且 $<i$ 的最小点，可以发现 BFS 序为 $1,2,\dots$ 当且仅当 $b$ 单调不降。

可以发现 $b_i$ 形成了一棵生成树。

令 $t_i=\sum_j[b_j=i]$，答案是 $\frac{(n-1)!}{\prod t_i!}$，因为一个节点的儿子顺序是不能任取的。（？

# T3

记 $g(x)$ 表示覆盖 $(x,fa_x)$ 的路径中最浅的点。如果是计算 $f(i,j)$ 貌似就是直接倍增跳到深度 $\le $ LCA 的点，但是可能算多一步，记 $i'$ 和 $j'$ 表示上一步跳到的点，如果存在路径覆盖 $i'-\text{LCA}-j'$ 就可以少一步。

这道题貌似谷上有，忘记题号了。

考虑分开来算，对于第一部分，考虑 $g$ 形成的重构树，则相当于统计一个带权树上前缀和，在这个重构树上 DFS，则相当于每次往当前答案上加上一个树上前缀和，直接做就可以了。

第二部分，肯定是要枚举 LCA 的，考虑从下到上枚举 $p$ 为 LCA，则对 $p$ 子树内的一点 $u$，维护 $a_u$ 表示从 $u$ 开始跳不超过 $p$ 的最浅跳到的点。

对于 $a$ 相同的点，它们后续的变化也是相同的，因此记 $S_v$ 表示满足 $a_u=v$ 的点的集合，我们需要维护 $S_v$ 的大小。

可以发现，只有当 $a_i=x$ 且 $g_x=p$ 时，$a_i\gets p$。也就是说，每次可以找到 $g_x=p$ 的 $x$ 然后 $S_p\gets S_p\cup S_x$。

如何统计答案？点 $i$ 在 $p$ 处得到的贡献，就是满足 $(a_i,j)$ 被至少一条路径完全覆盖的 $|S_j|$ 之和，显然对于所有 $a_i$ 相同的 $i$ 它的贡献都是一样的，因此我们先把贡献记在 $a_i$，即 $c_{a_i}$。

枚举 $p$ 的儿子 $v$，找到所有 LCA 为 $p$ 且一端在 $v$ 内的路径 $(x,y)$ 其中 $x$ 在 $v$ 内。

建出所有这些 $x$ 形成的虚树，那么，对于虚树上的每条边，$p$ 对上面的点的贡献 $c$ 都是一致的，做一个树上差分就可以了。每个 $(x,y)$ 相当于对 $y$ 的子树 DFN 区间做一个区间覆盖，那么在虚树上做一个线段树合并即可。

然后需要对所有的 $i$，对其 $j\in S_i$ 做 $a_j\gets a_j-c_i$。

不难发现 $S$ 其实就是上面的 $g$ 重构树的子树集合，所以再做一个树上前缀和就可以了。

其实没什么 DS 科技，主要是长思维链的耐心。