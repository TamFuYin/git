# T1

转化为 $\max l\le \min r$ 的条件，考虑点分治。

暴力是枚举 $x=\max l$，相当于统计

- $\forall l\le x$
- $\exist l=x$
- $\forall r\ge x$

的连通块的个数。

$\exist l=x$ 的条件不好办，考虑用 $\forall l\le x,\forall r\ge x$ 的个数减去 $\forall l<x,\forall r\ge x$ 的个数。

当 $x$ 移动时，可以均摊线性地维护满足 $l\le x$ 且 $r\ge x$ 的点集。

现要求实时维护包含根的连通块的形态，即维护 $f_i=\prod_{j\in \mathrm{son}_i}(f_j+1)$。

用树剖 DDP？~~貌似不能写成矩乘的形式。~~可以写成矩乘的形式。不过就一个简单的 乘-加 标记，不用写成矩阵。

点分治没有必要，直接维护全局求和即可。每个连通块只在其顶点处被统计到。

所以只有两只 log（树剖+线段树）可以通过

---

RE：可以线段树合并维护。

# [T2](https://qoj.ac/problem/5039)

相当于求整数序列 $x$ 的方案数，满足

- 序列长度为 $n$
- $0\le x_1\le x_2\le \dots\le x_n\le m$
- $\sum_{i=1}^n(-1)^{i+1}(x_i\bmod 2)=k$

考虑如果确定了 $a_i=x_i\bmod 2$，其方案数几何？

单调不降的条件很烦。但是我们发现如果先忽略掉这个条件，然后对于每个方案进行排序，那么算重的方案即为 $\dbinom{n}{s_0,s_1,\dots,s_m}$，其中 $s_i$ 表示 $\sum_{j=1}^n[a_j=i]$。
$$
[x^nn!]\prod_{i=0}^m\left(\sum_{j\ge 0}x^j j!\right)
$$
然后不会了。待补

# [T3](https://www.luogu.com.cn/problem/AT_arc183_f)

真就一股 ARC 的风格（而且我貌似还见过的样子

令 $d=\gcd(A,B)$ 那么 $f(n)=[d|n]f'(n/d)$，其中 $f'$ 表示 $A'=A/d,B'=B/d$ 时的答案，所以之后认为 $\gcd(A,B)=1$。

注意到题目给出 $1\le N\le A+B-1$，所以要么只会 $+A-B$ 要么只会 $-A+B$，而且可以保持 $x$ 一直在 $[0,A+B-1]$ 之间。方法是：假如我们选择只 $+A$ 和 $-B$，那么当 $x<B$ 时，做 $+A$，否则 $-B$。

记上面的操作为 $A$ 操作，不难发现 $A$ 操作本质上是 $\bmod (A+B)$ 意义下 $+A$。

另外一种情况是 当 $x<A$ 时 $+A$ 否则 $-B$，称 $B$ 操作，即 $\bmod (A+B)$ 意义下 $+B$，也可以认为是 $-A$。

由于 $\gcd(A,A+B)=1$，可以发现 $x$ 能够遍历完剩余系内的所有点。因此形成了一个环。$A$ 操作是正着走，$B$ 操作是逆着走。

找到 $0$ 的对踵点，不难发现正方向的点只经由 $A$ 操作到达，反之同理。

最终问题形如

- 给定整数 $A,B,X,Y,N,K$，最初有 $x=0,cur=0,ans=0$，求出以下操作 $K$ 次后的 $ans$ 值
  - $x<B$ 时
    - 如果 $x\le N$，则 $ans+=cur$
    - $x+=A,cur+=X$
  - $x\ge B$ 时
    - 如果 $x\le N$，则 $ans+=cur$
    - $x-=B,cur+=Y$

这里 $K=n/2$ 左右。

我们可以把 $cur$ 和 $ans$ 绑起来，形成一个向量 $ans=\begin{bmatrix}ans\\cur\\1 \end{bmatrix}$。[^1]

记 $AX=\begin{bmatrix}1&1&0\\0&1&X\\0&0&1\end{bmatrix}$，$AY=\begin{bmatrix}1&0&0\\0&1&X\\0&0&1\end{bmatrix}$

$BX$ 和 $BY$​，那么可以重写为

- 给定整数 $A,B,X,Y,N,K$，最初有 $ans=\begin{bmatrix}0\\0\\1 \end{bmatrix}$，求出以下操作 $K$ 次后的 $ans$ 值
  - $x<B$ 时
    - 如果 $x\le N$，则 $ans\gets AX\times ans$，否则 $ans\gets AY\times ans$
    - $x+=A$
  - $x\ge B$ 时
    - 如果 $x\le N$，则 $ans\gets BX\times ans$，否则 $ans\gets BY\times ans$
    - $x-=B$

不妨令 $A<B$，令 $B=pA+q$，则所有 $-B$ 的前面都会跟至少 $p$ 个 $+A$，可以把它们绑在一起操作，相当于当 $x\ge q$ 时 $-q$。

考虑这样对答案的影响，以下认为 $q\le x<B$。

如果 $x>N$。那么相当于左乘 $BYAY^{p}$。如果 $x+pA\le N$，相当于左乘 $BXAX^{p}$。否则，存在 $u(1\le u\le p)$ 使得 $x+(u-1)A\le N$ 且 $x+uA>N$，即 $u=\lfloor\frac{N-x}A\rfloor+1$。那么相当于左乘 $BYAY^{p-u}AX^u$。

熟悉类欧的同学做到这一步应该可以瞪出来了，但是我不会类欧。

注意到如果 $x+pA\le N$，那么 $N\ge x+pA\ge q+pA\ge B$。

[^1]: 译注：此处原题解仅描述为一<ruby>幺半群<rt>モノイド</rt></ruby>，过分抽象，故写作矩阵的形式方便理解。应当注意，矩阵乘法是从右往左的